<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>æ›¼è°·è¡Œç¨‹æŸ¥è©¢ï½œè‡ªç”¨ Today Modeï¼ˆThai Textileï¼‰</title>

  <!-- Thai fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@600;800&family=Sarabun:wght@400;600;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg: #fff6e8;
      --bg2:#f7fbff;

      --text:#1b2430;
      --muted:#5f6b7a;

      --thai-gold:#c9a227;     /* å¯ºå»Ÿé‡‘ */
      --thai-gold2:#e7cf86;    /* é‡‘ç®”äº® */
      --thai-teal:#0f766e;     /* å­”é›€è— */
      --thai-red:#b42318;      /* æœ±ç´… */
      --thai-ink:#111827;

      --card-bg:#ffffff;
      --border: rgba(17,24,39,0.10);

      --shadow-soft: 0 12px 34px rgba(17,24,39,0.10);
      --shadow-tight: 0 10px 24px rgba(17,24,39,0.12);

      --radius-xl: 24px;
      --radius-lg: 18px;

      --sans: "Sarabun","PingFang TC","Noto Sans TC",system-ui,-apple-system,sans-serif;
      --display: "Kanit","PingFang TC","Noto Sans TC",system-ui,-apple-system,sans-serif;
    }

    *{box-sizing:border-box; -webkit-tap-highlight-color: transparent;}

    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      min-height:100vh;
      overflow-x:hidden;

      /* Thai textile (dense) background */
      background:
        radial-gradient(900px 460px at 18% 0%, rgba(201,162,39,0.12), transparent 62%),
        radial-gradient(780px 420px at 92% 8%, rgba(15,118,110,0.14), transparent 58%),
        radial-gradient(700px 380px at 70% 95%, rgba(180,35,24,0.10), transparent 60%),

        repeating-linear-gradient(90deg,
          rgba(17,24,39,0.04) 0px,
          rgba(17,24,39,0.04) 1px,
          transparent 1px,
          transparent 8px
        ),
        repeating-linear-gradient(0deg,
          rgba(17,24,39,0.035) 0px,
          rgba(17,24,39,0.035) 1px,
          transparent 1px,
          transparent 10px
        ),

        repeating-linear-gradient(45deg,
          rgba(15,118,110,0.05) 0px,
          rgba(15,118,110,0.05) 2px,
          transparent 2px,
          transparent 12px
        ),
        repeating-linear-gradient(-45deg,
          rgba(201,162,39,0.06) 0px,
          rgba(201,162,39,0.06) 2px,
          transparent 2px,
          transparent 12px
        ),

        repeating-conic-gradient(
          from 0deg at 50% 18%,
          rgba(201,162,39,0.035) 0 7deg,
          transparent 7deg 18deg
        ),

        linear-gradient(180deg, var(--bg) 0%, var(--bg2) 100%);
    }

    header{
      padding: 26px 20px 8px;
      text-align:center;
    }
    h1{
      margin:0;
      font-family: var(--display);
      font-size: 32px;
      font-weight: 800;
      letter-spacing: 1.2px;
      color: var(--thai-ink);
      text-shadow: 0 2px 0 rgba(231,207,134,0.45);
      line-height: 1.05;
    }
    .sub{
      margin-top: 8px;
      font-size: 13px;
      font-weight: 800;
      color: var(--muted);
    }

    .hero-bar{
      margin: 14px auto 0;
      max-width: 720px;
      border-radius: 999px;
      padding: 10px 14px;
      background: rgba(255,255,255,0.80);
      border: 1px solid rgba(201,162,39,0.35);
      box-shadow: 0 14px 34px rgba(17,24,39,0.08);
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
    }
    .hero-badge{
      font-weight: 900;
      font-size: 12px;
      color: var(--thai-teal);
      letter-spacing: .2px;
    }
    .hero-dot{
      width:6px;height:6px;border-radius:50%;
      background: var(--thai-gold);
    }

    .wrap{max-width:1100px; margin:0 auto; padding-bottom: 60px;}

    .search-container { padding: 0 20px 18px; }
    .search-box{
      display:flex; align-items:center; gap:10px;
      background:
        linear-gradient(180deg, rgba(255,255,255,0.92), rgba(255,255,255,0.86)),
        repeating-linear-gradient(90deg,
          rgba(201,162,39,0.06) 0 10px,
          transparent 10px 22px
        );
      border: 1px solid rgba(201,162,39,0.40);
      border-radius: 999px;
      padding: 10px 14px;
      box-shadow: var(--shadow-soft);
      backdrop-filter: blur(8px);
    }
    .search-box input{ all:unset; flex:1; font-size: 15px; color: var(--text); }

    .pill{
      border:none;
      padding: 8px 12px;
      border-radius: 999px;
      font-weight: 900;
      font-size: 12px;
      cursor: pointer;
      white-space: nowrap;
      background: rgba(17,24,39,0.06);
      color: var(--thai-ink);
    }
    .pill.primary{
      background: linear-gradient(90deg, var(--thai-teal), #12a39a);
      color:#fff;
      box-shadow: 0 14px 22px rgba(15,118,110,0.22);
    }
    .pill.gold{
      background: linear-gradient(90deg, var(--thai-gold2), var(--thai-gold));
      color: #1f2937;
      box-shadow: 0 14px 22px rgba(201,162,39,0.26);
    }

    .grid{ display:block; }
    .day-selector{
      display:flex; overflow-x:auto;
      padding: 0 15px 20px; gap: 10px;
      -webkit-overflow-scrolling: touch;
    }
    .day-selector::-webkit-scrollbar { display:none; }

    .daybtn{
      flex: 0 0 118px;
      background:
        linear-gradient(180deg, rgba(255,255,255,0.94), rgba(255,255,255,0.88)),
        repeating-linear-gradient(90deg, rgba(17,24,39,0.035) 0 1px, transparent 1px 9px),
        repeating-linear-gradient(0deg, rgba(17,24,39,0.03) 0 1px, transparent 1px 11px),
        repeating-linear-gradient(45deg, rgba(201,162,39,0.06) 0 2px, transparent 2px 14px);
      border: 1px solid rgba(201,162,39,0.28);
      border-radius: 16px;
      padding: 10px;
      text-align:center;
      cursor:pointer;
      box-shadow: 0 14px 26px rgba(17,24,39,0.08);
    }
    .daybtn strong{
      display:block;
      font-family: var(--display);
      font-size: 15px;
      color: var(--thai-teal);
    }
    .daybtn small{ font-size: 11px; color: var(--muted); font-weight: 800; }
    .daybtn.active{
      background:
        linear-gradient(180deg, rgba(15,118,110,0.96), rgba(15,118,110,0.84)),
        repeating-linear-gradient(45deg,
          rgba(231,207,134,0.18) 0 2px,
          transparent 2px 10px
        );
      border-color: rgba(231,207,134,0.55);
    }
    .daybtn.active strong, .daybtn.active small{ color:#fff; }

    .main-panel{ padding: 0 20px; }

    .title-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:4px;
    }
    .title-left{
      display:flex;
      align-items:center;
      gap:10px;
      min-width: 0;
    }
    .title-text{
      font-weight: 900;
      font-size: 20px;
      color: var(--text);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Badge base */
    .badge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 6px 10px;
      border-radius: 999px;
      font-weight: 900;
      font-size: 12px;
      letter-spacing: .2px;
      border: 1px solid rgba(201,162,39,0.34);
      background: rgba(255,255,255,0.78);
      backdrop-filter: blur(8px);
      box-shadow: 0 10px 20px rgba(17,24,39,0.08);
      flex: 0 0 auto;
    }
    .badge i{
      width: 14px;
      height: 14px;
      border-radius: 4px;
      display:inline-block;
      position: relative;
      overflow:hidden;
    }

    /* Old Town: temple spire */
    .badge.temple{ border-color: rgba(201,162,39,0.45); }
    .badge.temple i{
      background: linear-gradient(180deg, rgba(231,207,134,0.90), rgba(201,162,39,0.55));
    }
    .badge.temple i::before{
      content:"";
      position:absolute; inset:2px 3px 2px 3px;
      background: linear-gradient(180deg, rgba(15,118,110,0.85), rgba(15,118,110,0.35));
      clip-path: polygon(50% 0%, 66% 22%, 66% 100%, 34% 100%, 34% 22%);
    }
    .badge.temple i::after{
      content:"";
      position:absolute; left:50%; top:1px;
      width:4px; height:4px;
      transform: translateX(-50%);
      background: rgba(180,35,24,0.85);
      border-radius: 50%;
    }

    /* Riverside: wave */
    .badge.river{ border-color: rgba(15,118,110,0.45); }
    .badge.river i{
      background: linear-gradient(180deg, rgba(15,118,110,0.30), rgba(15,118,110,0.12));
    }
    .badge.river i::before{
      content:"";
      position:absolute; inset:-2px;
      background: repeating-linear-gradient(90deg, rgba(15,118,110,0.55) 0 2px, transparent 2px 6px);
      opacity: .55;
      transform: rotate(12deg);
    }
    .badge.river i::after{
      content:"";
      position:absolute; left:-2px; right:-2px; bottom:2px; height:6px;
      background: repeating-linear-gradient(90deg, rgba(201,162,39,0.55) 0 10px, transparent 10px 16px);
      opacity:.35;
    }

    /* Outskirts: rail/market grid */
    .badge.market{ border-color: rgba(180,35,24,0.35); }
    .badge.market i{
      background:
        repeating-linear-gradient(90deg, rgba(17,24,39,0.14) 0 1px, transparent 1px 5px),
        repeating-linear-gradient(0deg, rgba(17,24,39,0.12) 0 1px, transparent 1px 6px),
        linear-gradient(180deg, rgba(231,207,134,0.55), rgba(255,255,255,0.0));
    }
    .badge.market i::after{
      content:"";
      position:absolute; left:0; right:0; bottom:0; height:3px;
      background: rgba(180,35,24,0.7);
    }

    /* Textile: ari/asok */
    .badge.textile{ border-color: rgba(201,162,39,0.32); }
    .badge.textile i{
      background:
        repeating-linear-gradient(45deg, rgba(201,162,39,0.22) 0 2px, transparent 2px 8px),
        repeating-linear-gradient(-45deg, rgba(15,118,110,0.18) 0 2px, transparent 2px 9px),
        linear-gradient(180deg, rgba(255,255,255,0.85), rgba(255,255,255,0.65));
    }

    .section-header{
      display:flex; align-items:center; gap:8px;
      margin: 22px 0 12px;
      position: relative;
    }
    .section-header span{
      font-weight: 900;
      font-size: 16px;
      color: var(--thai-ink);
    }
    .section-header::after{
      content:"";
      flex:1;
      height:2px;
      margin-left: 10px;
      border-radius:999px;
      background: linear-gradient(90deg, rgba(201,162,39,0.55), rgba(15,118,110,0.35), transparent);
    }
    .dot{ width:8px; height:8px; border-radius: 999px; }

    .timeline{ display:flex; flex-direction:column; gap:12px; }

    .item-card{
      position: relative;
      background:
        linear-gradient(180deg, rgba(255,255,255,0.96), rgba(255,255,255,0.90)),
        repeating-linear-gradient(90deg, rgba(17,24,39,0.02) 0 1px, transparent 1px 10px),
        repeating-linear-gradient(0deg, rgba(17,24,39,0.018) 0 1px, transparent 1px 12px);
      border: 1px solid rgba(201,162,39,0.38);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-tight);
      overflow:hidden;
      will-change: transform;
    }
    .item-card::before{
      content:"";
      position:absolute;
      inset:10px;
      border-radius: calc(var(--radius-xl) - 10px);
      border: 1px dashed rgba(201,162,39,0.42);
      pointer-events:none;
      opacity: .95;
    }
    .item-card::after{
      content:"";
      position:absolute;
      inset:-1px;
      border-radius: var(--radius-xl);
      padding:1px;
      background: linear-gradient(120deg, rgba(231,207,134,0.55), rgba(201,162,39,0.28), rgba(15,118,110,0.22));
      -webkit-mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
      -webkit-mask-composite: xor;
              mask-composite: exclude;
      pointer-events:none;
    }

    .item-content{ display:grid; grid-template-columns: 70px 1fr; gap: 12px; padding: 15px; }
    .time-tag{
      background:
        linear-gradient(180deg, rgba(231,207,134,0.28), rgba(231,207,134,0.18)),
        repeating-linear-gradient(90deg, rgba(17,24,39,0.04) 0 1px, transparent 1px 8px);
      border: 1px solid rgba(201,162,39,0.22);
      border-radius: 12px;
      height: 36px;
      display:grid; place-items:center;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      font-weight: 900;
      color: var(--thai-ink);
      font-size: 13px;
    }

    .what .w{ font-weight: 900; font-size: 16px; margin-bottom: 4px; color: var(--thai-ink); }
    .what .d{ color: var(--muted); font-size: 13px; line-height: 1.55; }

    .item-footer{
      padding: 9px 15px;
      background:
        linear-gradient(180deg, rgba(255,255,255,0.78), rgba(255,255,255,0.70)),
        repeating-linear-gradient(90deg, rgba(17,24,39,0.02) 0 1px, transparent 1px 10px),
        repeating-linear-gradient(45deg, rgba(201,162,39,0.05) 0 2px, transparent 2px 16px);
      border-top: 1px solid rgba(201,162,39,0.22);
      font-size: 11px;
      font-weight: 900;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }
    .footer-actions{ display:flex; gap:10px; align-items:center; }
    .footer-actions a{ color: var(--thai-teal); text-decoration:none; font-weight: 900; }
    .footer-actions a:nth-child(2){ color: var(--thai-red); }
    .footer-actions a:hover{ text-decoration: underline; }

    .trans-steps{
      background: rgba(255,255,255,0.92);
      border-radius: var(--radius-xl);
      border: 1px solid rgba(201,162,39,0.20);
      box-shadow: var(--shadow-soft);
      padding: 5px 0;
      overflow:hidden;
    }
    .t-step{
      display:flex; gap: 12px;
      padding: 12px 18px;
      border-bottom: 1px solid rgba(0,0,0,0.03);
    }
    .t-step:last-child{ border-bottom:none; }
    .t-n{
      min-width: 22px; height: 22px; border-radius: 50%;
      background: rgba(15,118,110,0.88);
      color: #fff;
      display:grid; place-items:center;
      font-weight: 900; font-size: 11px;
    }
    .t-txt .a{ font-weight: 900; font-size: 13.5px; color: var(--thai-ink); display:block; }
    .t-txt .b{ font-size: 12px; color: var(--muted); margin-top: 2px; line-height: 1.45; }

    .meals-grid{ display:grid; grid-template-columns: 1fr; gap:12px; }
    .meal-box{
      background: #fff;
      border-radius: 15px;
      padding: 18px 15px 15px;   /* ä¸Šæ–¹å¤šç•™ç©ºé–“çµ¦ badge */
      border: 1px solid var(--border);
      position: relative;
      overflow: visible;          /* ä¿éšªï¼šé¿å…è¢«è£åˆ‡ */
}

.meal-type {
  position: absolute;
  top: 10px;                  /* ä¸è¦è² å€¼ï¼Œæ”¹æ”¾å¡ç‰‡å…§ */
  left: 15px;
  padding: 4px 10px;
  border-radius: 999px;       /* æ›´åƒ badge */
  font-size: 10px;
  font-weight: 900;
  color: #fff;
  line-height: 1;             /* é¿å…å­—è¢«åˆ‡ */
}
    }
    .meal-box ul{ margin: 8px 0 0; padding-left: 18px; }
    .meal-box li{ margin: 6px 0; font-size: 13.5px; }
    .meal-item-link{ color: var(--thai-teal); font-weight: 900; text-decoration: underline; cursor:pointer; }

    /* Today mode highlight */
    .item-card.next{
      outline: 2px solid rgba(201,162,39,0.45);
      box-shadow: 0 18px 34px rgba(17,24,39,0.10), 0 14px 30px rgba(201,162,39,0.16);
    }
    .item-card.next .time-tag{
      background:
        linear-gradient(180deg, rgba(231,207,134,0.36), rgba(231,207,134,0.20)),
        repeating-linear-gradient(90deg, rgba(17,24,39,0.04) 0 1px, transparent 1px 8px);
      border-color: rgba(201,162,39,0.35);
    }

    /* Bottom sheet */
    .overlay{ position:fixed; inset:0; background:rgba(0,0,0,0.34); display:none; z-index:999; }
    .sheet{
      position:fixed; left:0; right:0; bottom:0;
      background:
        linear-gradient(180deg, rgba(255,255,255,0.98), rgba(255,255,255,0.92)),
        repeating-linear-gradient(45deg, rgba(201,162,39,0.05) 0 2px, transparent 2px 10px);
      border-top: 7px solid var(--thai-gold);
      border-radius: 26px 26px 0 0;
      padding: 22px;
      display:none;
      z-index:1000;
      max-height: 78vh;
      overflow-y:auto;
    }
    .sheet.show, .overlay.show{ display:block; }
    .sheet-title{
      font-family: var(--display);
      font-weight: 800;
      font-size: 19px;
      color: var(--thai-ink);
      margin-bottom: 12px;
      letter-spacing: .3px;
    }
    .sheet-desc{ font-size: 14.5px; line-height: 1.7; white-space: pre-line; color: #374151; }

    /* Toast */
    .toast{
      position: fixed;
      left: 50%;
      bottom: 90px;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.75);
      color: #fff;
      padding: 10px 12px;
      border-radius: 12px;
      font-weight: 900;
      font-size: 12px;
      max-width: 85vw;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      z-index: 2000;
    }

    @media (min-width: 920px){
      .grid{ display:grid; grid-template-columns: 240px 1fr; }
      .day-selector{ flex-direction: column; position: sticky; top: 20px; height: auto; }
      .meals-grid{ grid-template-columns: 1fr 1fr 1fr; }
    }
  </style>
</head>

<body>
  <header>
    <h1>BANGKOK TRIP</h1>
    <div class="sub">Thai Textile Editionï½œToday Modeï½œæŸ¥çœ‹/å°èˆª/è¤‡è£½</div>

    <div class="hero-bar">
      <span class="hero-badge">Sawasdee Bangkok</span>
      <span class="hero-dot"></span>
      <span class="hero-badge">BTS / MRT / Pier Ready</span>
    </div>

    <div style="max-width:740px;margin:10px auto 0;opacity:.9">
      <svg viewBox="0 0 900 120" width="100%" height="54" aria-hidden="true">
        <path d="M60 104h780" stroke="rgba(17,24,39,0.18)" stroke-width="4" stroke-linecap="round"/>
        <path d="M210 104V70l18-10 18 10v34" fill="none" stroke="rgba(201,162,39,0.65)" stroke-width="5" stroke-linejoin="round"/>
        <path d="M450 104V42l30-18 30 18v62" fill="none" stroke="rgba(15,118,110,0.65)" stroke-width="6" stroke-linejoin="round"/>
        <path d="M450 42l30-18 30 18" fill="none" stroke="rgba(201,162,39,0.65)" stroke-width="4" stroke-linecap="round"/>
        <path d="M670 104V64l16-10 16 10v40" fill="none" stroke="rgba(201,162,39,0.65)" stroke-width="5" stroke-linejoin="round"/>
        <circle cx="450" cy="22" r="6" fill="rgba(180,35,24,0.65)"/>
      </svg>
    </div>
  </header>

  <div class="search-container">
    <div class="search-box">
      <input id="q" placeholder="å¿«é€Ÿæœå°‹ï¼ˆå¯æœæ™¯é»/é¤å»³/äº¤é€š/å‚™è¨»ï¼‰..." oninput="handleSearch()" />
      <button id="todayBtn" class="pill primary" onclick="toggleTodayMode()">ä»Šå¤©æ¨¡å¼ï¼šé–‹</button>
      <button class="pill gold" onclick="openHomeDir()">å›é£¯åº—</button>
    </div>
  </div>

  <div class="wrap">
    <div class="grid">
      <div class="day-selector" id="daylist"></div>

      <main class="main-panel">
        <div class="title-row">
          <div class="title-left">
            <div id="mainTitle" class="title-text"></div>
            <div id="dayBadge" class="badge temple" style="display:none;">
              <i></i><span id="badgeText"></span>
            </div>
          </div>
        </div>

        <div id="mainNote" style="font-size: 12.5px; color: var(--muted); margin-bottom: 18px;"></div>
        <div id="content"></div>
      </main>
    </div>
  </div>

  <div class="overlay" id="overlay" onclick="closeSheet()"></div>
  <div class="sheet" id="sheet">
    <div style="display:flex; justify-content:space-between; align-items:start; gap:10px;">
      <div id="sheetTitle" class="sheet-title"></div>
      <div style="display:flex; gap:8px;">
        <button class="pill" onclick="openSheetView()">æŸ¥çœ‹</button>
        <button class="pill" onclick="copySheetQ()">è¤‡è£½</button>
        <button class="pill primary" onclick="openSheetNav()">å°èˆª</button>
        <button class="pill" onclick="closeSheet()">é—œé–‰</button>
      </div>
    </div>
    <div id="sheetDesc" class="sheet-desc"></div>
  </div>

<script>
'use strict';

/* =========================
   Utilities
========================= */
const toMapsSearch = (q) => `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(q)}`;
const toMapsDir = (q) => `https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(q)}&travelmode=transit`;

const formatDateZh = (iso) => {
  const d = new Date(iso + 'T00:00:00');
  const wk = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][d.getDay()];
  const m = d.getMonth() + 1;
  const day = d.getDate();
  return `${m}/${day}ï¼ˆ${wk}ï¼‰`;
};

const toast = (msg) => {
  const t = document.createElement('div');
  t.className = 'toast';
  t.textContent = msg;
  document.body.appendChild(t);
  setTimeout(() => { t.style.opacity = '0'; t.style.transition = 'opacity .25s'; }, 900);
  setTimeout(() => t.remove(), 1200);
};

const copyText = async (text) => {
  try{
    await navigator.clipboard.writeText(text);
    toast(`å·²è¤‡è£½ï¼š${text}`);
  }catch(e){
    const ta = document.createElement('textarea');
    ta.value = text;
    ta.style.position = 'fixed';
    ta.style.left = '-9999px';
    document.body.appendChild(ta);
    ta.select();
    document.execCommand('copy');
    document.body.removeChild(ta);
    toast(`å·²è¤‡è£½ï¼š${text}`);
  }
};
// ===== Safe HTML helpers =====
const escapeHtml = (s='') =>
  String(s).replaceAll('&','&amp;')
           .replaceAll('<','&lt;')
           .replaceAll('>','&gt;')
           .replaceAll('"','&quot;')
           .replaceAll("'","&#39;");

const escapeAttr = (s='') =>
  String(s).replaceAll('&','&amp;')
           .replaceAll('"','&quot;')
           .replaceAll("'","&#39;")
           .replaceAll('<','&lt;')
           .replaceAll('>','&gt;')
           .replaceAll('\n','\\n');

// ===== Place registry (avoid inline object in HTML) =====
const placeRegistry = Object.create(null);
let placeSeq = 1;

const registerPlace = (p) => {
  const base = (p?.q || p?.name || '').trim() || ('p' + placeSeq);
  const key = 'p_' + btoa(unescape(encodeURIComponent(base))).slice(0,18).replaceAll('=','') + '_' + (placeSeq++);
  placeRegistry[key] = p;
  return key;
};

// ===== Event delegation for meal clicks (mobile-safe) =====
document.addEventListener('click', (e) => {
  const el = e.target.closest('[data-action="open-meal"]');
  if(!el) return;

  const key = el.getAttribute('data-placekey');
  const desc = (el.getAttribute('data-desc') || '').replaceAll('\\n','\n');
  const placeObj = placeRegistry[key];

  if(placeObj){
    window.openMeal(placeObj, desc);
  }else{
    toast('æ‰¾ä¸åˆ°è©²ç¾é£Ÿè³‡æ–™ï¼ˆè«‹é‡æ–°æ•´ç†é é¢ï¼‰');
  }
});
/* =========================
   Places
========================= */
const HOME = {
  name: "Metro Hotel Phahonyothin 35",
  thai: "",
  q: "Metro Hotel Phahonyothin 35, 168 Phahonyothin 35 Alley, Chatuchak, Bangkok 10900",
  address: "168 Phahonyothin 35 Alley, Chatuchak, Bangkok 10900",
  note: "å··å…§é£¯åº—ï¼›å›ç¨‹æ™šé–“æ³¨æ„å··å£è»Šæµã€‚Grab æœ€ç©©ã€‚",
  access: { bts: "BTSï¼ˆåŒ—å€ï¼‰", exit: "ä¾å°èˆª", lastMile: "å‡ºç«™å¾Œ Grab 5â€“10 åˆ†é˜ï¼ˆè¦–å¡è»Šï¼‰" }
};

const PLACES = {
  BKK: {
    name: "Suvarnabhumi Airport (BKK)",
    thai: "à¸—à¹ˆà¸²à¸­à¸²à¸à¸²à¸¨à¸¢à¸²à¸™à¸ªà¸¸à¸§à¸£à¸£à¸“à¸ à¸¹à¸¡à¸´",
    q: "Suvarnabhumi Airport (BKK)",
    address: "Suvarnabhumi Airport",
    note: "ARL åœ¨åœ°ä¸‹ä¸€æ¨“ï¼›æ›åŒ¯çœ‹ SuperRich ç‰Œåƒ¹å†æ±ºå®šã€‚",
    access: { lastMile: "ARL ç›´é”å¸‚å€" }
  },
  HOME,

  GRAND_PALACE: {
    name: "The Grand Palace å¤§çš‡å®®",
    thai: "à¸à¸£à¸°à¸šà¸£à¸¡à¸¡à¸«à¸²à¸£à¸²à¸Šà¸§à¸±à¸‡",
    q: "The Grand Palace Bangkok",
    note: "æœè£ï¼šé•·è¤²/éè†ã€é®è‚©ï¼›æ—©å»é¿äººæ½®ã€‚",
    access: { mrt: "MRT Sanam Chai", lastMile: "æ­¥è¡Œ 10â€“15 åˆ†é˜" }
  },
  WAT_PHO: {
    name: "Wat Pho è‡¥ä½›å¯º",
    thai: "à¸§à¸±à¸”à¹‚à¸à¸˜à¸´à¹Œ",
    q: "Wat Pho Bangkok",
    note: "é‹å­å¥½ç©¿è„«ï¼›å®¤å…§äººå¤šï¼Œè¼•è£ã€‚",
    access: { mrt: "MRT Sanam Chai", lastMile: "æ­¥è¡Œ 10â€“15 åˆ†é˜" }
  },
  WAT_ARUN: {
    name: "Wat Arun é„­ç‹å»Ÿ",
    thai: "à¸§à¸±à¸”à¸­à¸£à¸¸à¸“à¸£à¸²à¸Šà¸§à¸£à¸²à¸£à¸²à¸¡",
    q: "Wat Arun Bangkok",
    note: "å‚æ™šæœ€å¥½çœ‹ï¼›æ¸¡è¼ªå¾ Tha Tien ä¸€å¸¶å‡ºç™¼ã€‚",
    access: { pier: "Tha Tien / Wat Arun ferry", lastMile: "æ¸¡è¼ª 5 åˆ†é˜" }
  },
  YAOWARAT: {
    name: "Yaowarat Chinatown å”äººè¡—",
    thai: "",
    q: "Yaowarat Road Chinatown Bangkok",
    note: "å¤œæ™šäººæ½®çŒ›ï¼šå…ˆé– 2â€“3 å®¶ï¼Œä¸è¦ç¡¬é‘½ã€‚",
    access: { mrt: "MRT Wat Mangkon", lastMile: "å‡ºç«™å³ç†±å€" }
  },

  MAEKLONG: { name:"Maeklong Railway Market ç¾åŠŸéµé“å¸‚å ´", thai:"", q:"Maeklong Railway Market", note:"ç«™ä½æ³¨æ„å®‰å…¨ç·šï¼›çœ‹ç«è»Šæ™‚é–“ã€‚", access:{ lastMile:"å¤šç‚ºåŒ…è»Š/è·Ÿåœ˜" } },
  DAMNOEN: { name:"Damnoen Saduak Floating Market ä¸¹å«©èæœµæ°´ä¸Šå¸‚å ´", thai:"", q:"Damnoen Saduak Floating Market", note:"å…ˆå•æ¸…æ¥šèˆ¹åƒ¹/æ™‚é–“å†ä¸Šèˆ¹ã€‚", access:{ lastMile:"å¤šç‚ºåŒ…è»Š/è·Ÿåœ˜" } },

  TCDC: { name:"TCDC Bangkok è¨­è¨ˆä¸­å¿ƒ", thai:"", q:"TCDC Bangkok", note:"å…ˆçœ‹å±•å€å‹•ç·šå†é€›æ›¸/é¸å“ã€‚", access:{ lastMile:"ä¾å°èˆªæ­¥è¡Œ" } },

  ICONSIAM: { name:"ICONSIAM", thai:"", q:"ICONSIAM", note:"SookSiam å®¤å…§å¸‚é›†ï¼Œé›¨å¤©è¶…å¥½ç”¨ã€‚", access:{ bts:"BTS Saphan Taksin (S6)", lastMile:"æ¥é§èˆ¹/å«è»Š" } },

  ICONSIAM_PIER4: {
    name:"ICONSIAM 4è™Ÿç¢¼é ­ï¼ˆPier 4ï¼‰",
    thai:"",
    q:"ICONSIAM Pier 4 Bangkok",
    address:"ICONSIAM, Bangkok",
    note:"å…ˆæ‰¾éŠèˆ¹ Check-in æ«ƒå°ï¼Œå†ä¾æŒ‡ç¤ºåˆ° Pier 4ï¼›å»ºè­°ææ—© 20â€“30 åˆ†é˜åˆ°ã€‚",
    access:{ bts:"BTS Saphan Taksin (S6)", pier:"Pier 4", lastMile:"æ¥é§èˆ¹/æ­¥è¡Œä¾ç¾å ´æŒ‡ç¤º" }
  },

  ARI: { name:"Ari æ–‡é’å€ï¼ˆBTS Ariï¼‰", thai:"", q:"Ari BTS Station Bangkok", note:"å··å¼„å’–å•¡å¤šï¼ŒæŒ‘ 1â€“2 é–“å°±å¥½ã€‚", access:{ bts:"BTS Ari (N5)", lastMile:"æ­¥è¡Œ" } },

  MAKKHA_ASOKE: {
    name:"Makkha Health & Spaï¼ˆHeritage Asokeï¼‰",
    thai:"",
    q:"Makkha Health & Spa (Heritage Asoke)",
    note:"å»ºè­°é ç´„ï¼›æå‰ 10 åˆ†é˜åˆ°ã€‚æŒ‰å®Œå» Terminal 21 å¾ˆé †ã€‚",
    access:{ bts:"BTS Asok (E4)", mrt:"MRT Sukhumvit", lastMile:"æ­¥è¡Œ 5â€“10 åˆ†é˜" }
  },

  TERMINAL21: {
    name:"Terminal 21 Asok",
    thai:"",
    q:"Terminal 21 Asok",
    note:"Pier 21 åœ¨ 5Fï¼›å…ˆæ‰¾åº§ä½å†è²·ã€‚",
    access:{ bts:"BTS Asok (E4)", mrt:"MRT Sukhumvit", lastMile:"å‡ºç«™å³åˆ°" }
  },

  PRANAKORN_BOAT: { name:"Pranakorn Boat Noodle èˆ¹éºµ", thai:"", q:"Pranakorn Boat Noodle Victory Monument Bangkok", note:"ä»½é‡å°ï¼Œä¸€äºº 4â€“6 ç¢—èµ·è·³ã€‚", access:{ lastMile:"ä¾å°èˆª" } },
  GO_ANG: { name:"ç´…å¤§å“¥æµ·å—é›é£¯ Go-Ang Pratunam", thai:"", q:"Go-Ang Pratunam Chicken Rice Bangkok", note:"å°–å³°æ’éšŠæ­£å¸¸ã€‚", access:{ lastMile:"ä¾å°èˆª" } },
  ON_LOK_YUN: { name:"é‚¢æ³°è¨˜æ—©é¤ On Lok Yun", thai:"", q:"On Lok Yun Bangkok", note:"è€åº—ç¯€å¥æ…¢ï¼Œæ”¾é¬†åƒã€‚", access:{ lastMile:"ä¾å°èˆª" } },
  KRUAA_APSORN: { name:"Krua Apsorn çš‡å®¤æ–™ç†", thai:"", q:"Krua Apsorn Bangkok", note:"èŸ¹è‚‰ç…è›‹å¿…é»ã€‚", access:{ lastMile:"ä¾å°èˆª" } },
  GUAY_JUB: { name:"Guay Jub Ouan Pochanaï¼ˆè±¬é›œæ¹¯ï¼‰", thai:"", q:"Guay Jub Ouan Pochana Bangkok", note:"èƒ¡æ¤’å‘³å¾ˆé‡ã€‚", access:{ lastMile:"ä¾å°èˆª" } },
  YAOWARAT_TOAST: { name:"Yaowarat Toasted Breadï¼ˆç¢³çƒ¤åå¸ï¼‰", thai:"", q:"Yaowarat toasted bread Bangkok", note:"çˆ†æ¼¿åç”œï¼Œå…©äººåˆ†ä¸€ä»½å‰›å¥½ã€‚", access:{ lastMile:"ä¾å°èˆª" } },
  NANA_COFFEE: { name:"Nana Coffee Roasters", thai:"", q:"Nana Coffee Roasters Bangkok", note:"å’–å•¡æ°´æº–ç©©ã€‚", access:{ lastMile:"ä¾å°èˆª" } },
  OR_TOR_KOR: { name:"Or Tor Kor Market é ‚ç´šè¾²å¤«å¸‚å ´", thai:"", q:"Or Tor Kor Market Bangkok", note:"æ°´æœç¾åˆ‡è¶…å¼·ï¼›å¸¶æ¿•ç´™å·¾ã€‚", access:{ mrt:"MRT Kamphaeng Phet", lastMile:"æ­¥è¡Œ" } },
  PIER21: { name:"Pier 21 ç¾é£Ÿè¡—", thai:"", q:"Pier 21 Food Court Terminal 21", note:"å¾ˆæ“ ï¼šå…ˆå¡åº§ä½ã€‚", access:{ bts:"BTS Asok (E4)", mrt:"MRT Sukhumvit" } }
};

/* =========================
   Itinerary (Day badges included)
========================= */
const itinerary = [
  {
    id: 1, day: 'DAY 1', date: '2026-02-09', title: 'æŠµé”æ›¼è°·ï¼šè½åœ°å®‰é “',
    tag: { type:'textile', text:'Base & Settle' },
    note: 'ç¬¬ä¸€æ™šé‡é»ï¼šARL é€²å¸‚å€é¿å¡è»Šï¼›æœ€å¾Œä¸€æ®µç”¨ Grab ç›´é”é£¯åº—æœ€çœè…¦ã€‚',
    timeline: [
      { time: '18:10', place: PLACES.BKK, desc: 'å‡ºé—œé ˜è¡Œæï¼›BKK åœ°ä¸‹ä¸€æ¨“å¯çœ‹ SuperRich åŒ¯ç‡å†æ›ã€‚' },
      { time: '20:00', place: PLACES.HOME, desc: 'å…¥ä½å¾Œå…ˆæŠŠã€Œå›é£¯åº—ã€ç•¶æˆå›ºå®šå¿«æ·éµã€‚' }
    ],
    meals: {
      breakfast: [{ place: PLACES.BKK, d: 'æ©Ÿä¸Šè¼•é£Ÿï¼šå…ˆä¿é«”åŠ›ã€‚' }],
      lunch: [{ place: PLACES.BKK, d: 'æ©Ÿä¸Šä¸»é£Ÿï¼šä¸‹æ©Ÿå¾Œå†æˆ°ã€‚' }],
      dinner: [
        { place: PLACES.PRANAKORN_BOAT, d: 'å‹åˆ©ç´€å¿µç¢‘ååº—ï¼›èˆ¹éºµä»½é‡å°ï¼Œå»ºè­°ä¸€å£æ°£é»è¶³ã€‚' },
        { place: PLACES.GO_ANG, d: 'Go-Ang Pratunamï¼šæµ·å—é›é£¯ï¼‹è‹¦ç“œæ’éª¨æ¹¯ã€‚' }
      ]
    },
    transport: {
      headline: 'æ©Ÿå ´é€²å¸‚å€ï¼ˆè‡ªç”¨ä¿å‘½ç‰ˆï¼‰',
      steps: [
        { a: 'BKK â†’ ARL', b: 'åœ°ä¸‹ä¸€æ¨“æ­ ARL åˆ° Phaya Thaiã€‚' },
        { a: 'å¸‚å€ â†’ é£¯åº—', b: 'è»Œé“äº¤é€šåˆ°åŒ—å€å¾Œï¼Œæœ€å¾Œä¸€æ®µç”¨ Grab é€² Phahonyothin 35 Alleyã€‚' }
      ]
    }
  },

  {
    id: 2, day: 'DAY 2', date: '2026-02-10', title: 'è€åŸç¶“å…¸èˆ‡é„­ç‹å»Ÿ',
    tag: { type:'temple', text:'Old Town' },
    note: 'è€åŸæ ¸å¿ƒï¼šæ—©å»å¤§çš‡å®®é¿äººæ½®ï¼›é„­ç‹å»Ÿå‚æ™šå…‰ç·šæœ€å¥½ã€‚',
    timeline: [
      { time: '09:00', place: PLACES.GRAND_PALACE, desc: 'å¤§çš‡å®®ï¼šæœè£ä¸€å®šè¦éè†/é®è‚©ã€‚' },
      { time: '13:00', place: PLACES.WAT_PHO, desc: 'è‡¥ä½›å¯ºï¼šå®¤å…§äººå¤šï¼Œè¼•è£ç§»å‹•ã€‚' },
      { time: '15:30', place: PLACES.WAT_ARUN, desc: 'æ¸¡è¼ªè·¨æ²³çœ‹ç¢ç“·å°–å¡”ï¼›å‚æ™šæœ€ç¾ã€‚' },
      { time: '18:30', place: PLACES.YAOWARAT, desc: 'å”äººè¡—ï¼šå®µå¤œæˆ°å ´ï¼Œå…ˆé–å®š 2â€“3 å®¶å°±å¥½ã€‚' }
    ],
    meals: {
      breakfast: [{ place: PLACES.ON_LOK_YUN, d: 'è€å¼æ—©é¤ï¼‹ç…‰ä¹³å’–å•¡ï¼Œæ­¥èª¿æ…¢ï¼Œåˆ¥æ€¥ã€‚' }],
      lunch: [{ place: PLACES.KRUAA_APSORN, d: 'èŸ¹è‚‰ç…è›‹å¿…é»ï¼›å°–å³°æ’éšŠæ­£å¸¸ã€‚' }],
      dinner: [
        { place: PLACES.GUAY_JUB, d: 'èƒ¡æ¤’é¦™å¾ˆé‡ï¼Œç†±ç†±å–å¾ˆçˆ½ã€‚' },
        { place: PLACES.YAOWARAT_TOAST, d: 'çˆ†æ¼¿åå¸åç”œï¼Œå…©äººåˆ†ä¸€ä»½å‰›å¥½ã€‚' }
      ]
    },
    transport: {
      headline: 'è€åŸå€è½‰ä¹˜ï¼ˆä¸è¿·è·¯å¯«æ³•ï¼‰',
      steps: [
        { a: 'åˆ°è€åŸ', b: 'å…ˆåˆ° MRT Sanam Chaiï¼Œæ­¥è¡Œåˆ°å¤§çš‡å®®/è‡¥ä½›å¯ºã€‚' },
        { a: 'å»é„­ç‹å»Ÿ', b: 'åˆ° Tha Tien ç¢¼é ­æ­æ¸¡è¼ªè·¨æ²³ã€‚' },
        { a: 'å»å”äººè¡—', b: 'MRT åˆ° Wat Mangkonï¼ˆå‡ºç«™å°±é€²ç†±å€ï¼‰ã€‚' }
      ]
    }
  },

  {
    id: 3, day: 'DAY 3', date: '2026-02-11', title: 'éƒŠå€å¥‡è§€èˆ‡ä¼‘æ¯',
    tag: { type:'market', text:'Outskirts' },
    note: 'è»Šç¨‹é ï¼šå›ç¨‹å¡è»Šæ˜¯å¸¸æ…‹ï¼Œæ™šä¸Šå‹™å¿…ç•™çµ¦ä¼‘æ¯æˆ–å°±è¿‘åƒã€‚',
    timeline: [
      { time: '08:30', place: PLACES.MAEKLONG, desc: 'çœ‹ç«è»Šç©¿å¸‚å ´ï¼›ç«™ä½æ³¨æ„å®‰å…¨ç·šã€‚' },
      { time: '12:00', place: PLACES.DAMNOEN, desc: 'æ°´ä¸Šå¸‚å ´ï¼šå…ˆå•æ¸…æ¥šèˆ¹åƒ¹/æ™‚é–“å†ä¸Šèˆ¹ã€‚' }
    ],
    meals: {
      breakfast: [{ place: { name:'7-11 ç†±å£“åå¸', q:'7-Eleven Thailand', note:'å¿«é€Ÿè£œèƒ½é‡ã€‚' }, d: 'æ³°åœ‹ 7-11 å¿…åƒã€‚' }],
      lunch: [{ place: PLACES.DAMNOEN, d: 'èˆ¹ä¸Šç±³ç²‰æ¹¯ï¼šæ°´ä¸Šå¸‚å ´é™å®šé«”é©—ã€‚' }],
      dinner: [{ place: { name:'æ™šé¤ï¼ˆå½ˆæ€§ï¼‰', q: HOME.q, note:'å¡è»Šå›å¸‚å€æ™šï¼šç›´æ¥é£¯åº—é™„è¿‘åƒæœ€ç©©ã€‚' }, d: 'ä»Šå¤©ç•™å½ˆæ€§ï¼Œåˆ¥ç¡¬æ’é é»ã€‚' }]
    },
    transport: {
      headline: 'éƒŠå€å¾€è¿”',
      steps: [
        { a: 'å‡ºç™¼', b: 'åŒ…è»Š/è·Ÿåœ˜ç‚ºä¸»ï¼šæ—©å‡ºç™¼é¿å¡ã€‚' },
        { a: 'å›ç¨‹', b: 'å¡è»Šæ­£å¸¸ï¼šå›å¸‚å€å¾Œå…ˆå›é£¯åº—æ²–æ´—ã€‚' }
      ]
    }
  },

  {
    id: 4, day: 'DAY 4', date: '2026-02-12', title: 'è¨­è¨ˆæ›¼è°·èˆ‡éŠèˆ¹',
    tag: { type:'river', text:'Riverside' },
    note: 'ICONSIAM å¾ˆå¤§ï¼šä¸‹åˆä»¥æ¡è²·ï¼‹å®¤å…§å¸‚é›†ç‚ºä¸»ï¼›éŠèˆ¹ä»¥ Pier 4 ç‚ºæº–ã€‚',
    timeline: [
      { time: '11:00', place: PLACES.TCDC, desc: 'è¨­è¨ˆä¸­å¿ƒï¼šçœ‹å±•ï¼‹é¸å“ï¼Œç¯€å¥æ”¾æ…¢ã€‚' },
      { time: '15:00', place: PLACES.ICONSIAM, desc: 'SookSiam å®¤å…§å¸‚é›†ï¼šé›¨å¤©ä¹Ÿèƒ½é€›ã€‚' },
      { time: '19:45', place: PLACES.ICONSIAM_PIER4, desc: 'White Orchid Cruise ç™»èˆ¹ï¼šå…ˆ Check-in å†å» Pier 4ã€‚' }
    ],
    meals: {
      breakfast: [{ place: PLACES.HOME, d: 'é£¯åº—æ—©é¤ï¼šæ…¢æ…¢åƒï¼Œè£œè¡€ã€‚' }],
      lunch: [{ place: { name:'åˆé¤ï¼ˆæ²³å²¸/å¸‚ä¸­å¿ƒå½ˆæ€§ï¼‰', q:'Bang Rak Bangkok restaurants', note:'ä¾ç•¶å¤©å‹•ç·šå°±è¿‘åƒæœ€çœè…¦ã€‚' }, d: 'ç•™å½ˆæ€§ï¼Œé¿å…ç‚ºäº†åƒç¡¬æ‹‰è»Šç¨‹ã€‚' }],
      dinner: [{ place: PLACES.ICONSIAM, d: 'å…ˆåœ¨ ICONSIAM è£œé»æ±è¥¿ï¼ŒéŠèˆ¹ä¸Šå†åƒæ­£é¤ã€‚' }]
    },
    transport: {
      headline: 'æ²³å²¸è·¯ç·šï¼ˆå¯åŸ·è¡Œï¼‰',
      steps: [
        { a: 'åˆ° BTS Saphan Taksin', b: 'å…ˆå°èˆªåˆ° Saphan Taksinï¼ˆS6ï¼‰ã€‚' },
        { a: 'åˆ° ICONSIAM', b: 'æ¥é§èˆ¹æˆ–å«è»Šç›´é” ICONSIAMã€‚' },
        { a: 'ç™»èˆ¹', b: 'åˆ° Check-in â†’ å†åˆ° Pier 4ã€‚' }
      ]
    }
  },

  {
    id: 5, day: 'DAY 5', date: '2026-02-13', title: 'æ–‡é’æ—¥å¸¸èˆ‡æ­¸åœ‹',
    tag: { type:'textile', text:'Ari / Asok' },
    note: 'ä»Šå¤©é—œéµï¼šSPAï¼‹Terminal 21ï¼‹æ’¤é€€è·¯ç·šã€‚ç§»å‹•ç”¨è»Œé“ï¼‹çŸ­ç¨‹å«è»Šã€‚',
    timeline: [
      { time: '11:00', place: PLACES.ARI, desc: 'æ–‡é’å··å¼„ï¼šæŒ‘ 1â€“2 é–“å’–å•¡ï¼‹å°åº—å°±å¥½ã€‚' },
      { time: '15:00', place: PLACES.MAKKHA_ASOKE, desc: 'æŒ‰å®Œç›´æ¥å» Terminal 21 åƒæ™šé¤æœ€é †ã€‚' },
      { time: '18:00', place: PLACES.TERMINAL21, desc: 'Pier 21ï¼šå…ˆæ¶åº§ä½å†è²·ã€‚' },
      { time: '20:45', place: PLACES.BKK, desc: 'èµ° ARL æ’¤é€€æœ€ç©©ï¼›ææ—©æŠ“å‡ºç™¼æ™‚é–“ã€‚' }
    ],
    meals: {
      breakfast: [{ place: PLACES.NANA_COFFEE, d: 'æ‰‹æ²–/æ‹¿éµéƒ½ç©©ï¼›åˆ¥é»å¤ªå¤šç”œã€‚' }],
      lunch: [{ place: PLACES.OR_TOR_KOR, d: 'æ°´æœç¾åˆ‡ï¼šè²·äº†å°±åƒï¼Œåˆ¥èƒŒå¤ªä¹…ã€‚' }],
      dinner: [{ place: PLACES.PIER21, d: 'æ‰“æ‹‹è±¬ï¼‹é£²æ–™ï¼šç°¡å–®æ”¶å°¾ã€‚' }]
    },
    transport: {
      headline: 'æ­¸åœ‹æ’¤é€€ï¼ˆè‡ªç”¨ä¿å‘½ï¼‰',
      steps: [
        { a: 'Ari â†’ Asok', b: 'BTS åˆ° Asokï¼ˆæˆ–è½‰ä¹˜åˆ° Asokï¼‰ã€‚' },
        { a: 'å›é£¯åº—æ‹¿è¡Œæ', b: `ç›´æ¥å°èˆªå› ${HOME.name}ã€‚` },
        { a: 'å» BKK', b: 'èµ°è»Œé“åˆ° Phaya Thai è½‰ ARL åˆ° BKKã€‚' }
      ]
    }
  }
];

/* =========================
   State
========================= */
let currentDayId = 2;
let todayMode = true;
let sheetPlace = null;

/* =========================
   Today Mode helpers
========================= */
const todayIso = () => new Date().toISOString().slice(0,10);
const parseTimeOnDate = (iso, hhmm) => {
  const [hh, mm] = hhmm.split(':').map(Number);
  return new Date(`${iso}T${String(hh).padStart(2,'0')}:${String(mm).padStart(2,'0')}:00`);
};
const getNextIndexForDay = (dayObj) => {
  const now = new Date();
  const iso = todayIso();
  const isToday = dayObj.date === iso;
  if(!isToday) return 0;
  for(let i=0;i<dayObj.timeline.length;i++){
    const dt = parseTimeOnDate(iso, dayObj.timeline[i].time);
    if(dt > now) return i;
  }
  return Math.max(0, dayObj.timeline.length - 1);
};

/* =========================
   Sheet
========================= */
window.openMeal = (placeObj, desc) => {
  sheetPlace = placeObj || null;
  document.getElementById('sheetTitle').textContent = placeObj?.name || '';

  const extra = [
    placeObj?.thai ? `æ³°æ–‡ï¼š${placeObj.thai}` : '',
    placeObj?.address ? `åœ°å€ï¼š${placeObj.address}` : '',
    placeObj?.note ? `æç¤ºï¼š${placeObj.note}` : '',
    placeObj?.access?.bts ? `BTSï¼š${placeObj.access.bts}` : '',
    placeObj?.access?.mrt ? `MRTï¼š${placeObj.access.mrt}` : '',
    placeObj?.access?.exit ? `å‡ºå£ï¼š${placeObj.access.exit}` : '',
    placeObj?.access?.pier ? `ç¢¼é ­ï¼š${placeObj.access.pier}` : '',
    placeObj?.access?.lastMile ? `æœ€å¾Œä¸€æ®µï¼š${placeObj.access.lastMile}` : ''
  ].filter(Boolean).join('\n');

  document.getElementById('sheetDesc').textContent =
    (desc || '') + (extra ? `\n\n${extra}` : '');

  document.getElementById('sheet').classList.add('show');
  document.getElementById('overlay').classList.add('show');
};

window.openSheetNav = () => {
  const q = sheetPlace?.q || sheetPlace?.name || document.getElementById('sheetTitle').textContent;
  window.open(toMapsDir(q), '_blank', 'noopener');
};
window.openSheetView = () => {
  const q = sheetPlace?.q || sheetPlace?.name || document.getElementById('sheetTitle').textContent;
  window.open(toMapsSearch(q), '_blank', 'noopener');
};
window.copySheetQ = () => {
  const q = sheetPlace?.q || sheetPlace?.name || document.getElementById('sheetTitle').textContent;
  copyText(q);
};
window.closeSheet = () => {
  sheetPlace = null;
  document.getElementById('sheet').classList.remove('show');
  document.getElementById('overlay').classList.remove('show');
};

/* =========================
   Render
========================= */
const renderAll = () => {
  // Day list
  const daylist = document.getElementById('daylist');
  daylist.innerHTML = itinerary.map(d => `
    <div class="daybtn ${d.id === currentDayId ? 'active' : ''}" onclick="selectDay(${d.id})">
      <strong>${d.day}</strong><small>${formatDateZh(d.date)}</small>
    </div>
  `).join('');

  const d = itinerary.find(x => x.id === currentDayId) || itinerary[0];
  document.getElementById('mainTitle').textContent = `${d.day}ï½œ${d.title}`;
  document.getElementById('mainNote').textContent = d.note;

  // --- Title badge ---
  const badge = document.getElementById('dayBadge');
  const badgeText = document.getElementById('badgeText');
  if(d.tag && d.tag.type){
    badge.style.display = 'inline-flex';
    badge.className = `badge ${d.tag.type}`;
    badgeText.textContent = d.tag.text || '';
  }else{
    badge.style.display = 'none';
  }

  let html = `
    <div class="section-header">
      <div class="dot" style="background:rgba(201,162,39,0.9)"></div>
      <span>ğŸ“ è¡Œç¨‹å¡ï¼ˆæŸ¥çœ‹ / å°èˆª / è¤‡è£½ï¼‰</span>
    </div>
    <div class="timeline">
  `;

  d.timeline.forEach(it => {
    const p = it.place || { name: it.what, q: it.q || it.what, thai: "", note: "", access:{} };
    const q = p.q || p.name;

    const subLine = [
      p.thai ? `æ³°æ–‡ï¼š${p.thai}` : "",
      p.access?.bts ? p.access.bts : "",
      p.access?.mrt ? p.access.mrt : "",
      p.access?.exit ? `Exit ${String(p.access.exit).replace(/Exit\s*/i,'')}` : "",
      p.access?.pier ? p.access.pier : ""
    ].filter(Boolean).join(" ï½œ ");

    const tipLine = p.note ? `æç¤ºï¼š${p.note}` : "";

    html += `
      <div class="item-card">
        <div class="item-content">
          <div class="time-tag">${it.time}</div>
          <div class="what">
            <div class="w">${p.name}</div>
            <div class="d">${it.desc}</div>
            ${subLine ? `<div class="d" style="margin-top:6px;font-weight:900;color:#374151;">${subLine}</div>` : ``}
            ${tipLine ? `<div class="d" style="margin-top:6px;">${tipLine}</div>` : ``}
          </div>
        </div>
        <div class="item-footer">
          <span style="color:var(--muted); font-weight:900;">å¿«é€Ÿæ“ä½œ</span>
          <span class="footer-actions">
            <a href="${toMapsSearch(q)}" target="_blank" rel="noopener">æŸ¥çœ‹</a>
            <a href="${toMapsDir(q)}" target="_blank" rel="noopener">å°èˆª</a>
            <a href="javascript:void(0)" onclick="copyText('${q.replace(/\\/g,'\\\\').replace(/'/g,"\\'")}')">è¤‡è£½</a>
          </span>
        </div>
      </div>
    `;
  });

  html += `</div>`;

  // Transport
  html += `
    <div class="section-header">
      <div class="dot" style="background:rgba(15,118,110,0.9)"></div>
      <span>ğŸšŒ äº¤é€šè½‰ä¹˜ï¼ˆå¯åŸ·è¡Œï¼‰</span>
    </div>
    <div class="trans-steps">
      <div style="padding:15px 20px 5px; font-size:12px; font-weight:900; color:var(--thai-teal)">${d.transport.headline}</div>
      ${d.transport.steps.map((s, i) => `
        <div class="t-step">
          <div class="t-n">${i+1}</div>
          <div class="t-txt"><span class="a">${s.a}</span><span class="b">${s.b}</span></div>
        </div>
      `).join('')}
    </div>
  `;

   // Meals (SAFE: mobile friendly)
  html += `
    <div class="section-header">
      <div class="dot" style="background:rgba(180,35,24,0.85)"></div>
      <span>ğŸœ ç¾é£Ÿï¼ˆé»åå­— â†’ Sheet â†’ æŸ¥çœ‹/å°èˆª/è¤‡è£½ï¼‰</span>
    </div>
    <div class="meals-grid">
  `;

  const mTypesFixed = [
    {t:'æ—©é¤', k:'breakfast', c:'var(--thai-teal)'},
    {t:'åˆé¤', k:'lunch', c:'rgba(201,162,39,0.95)'},
    {t:'æ™šé¤', k:'dinner', c:'rgba(180,35,24,0.95)'}
  ];

  mTypesFixed.forEach(m => {
    html += `
      <div class="meal-box">
        <div class="meal-type" style="background:${m.c}">${m.t}</div>
        <ul>
    `;

    (d.meals[m.k] || []).forEach(item => {
      const p = item.place || { name: item.n, q: item.q || item.n, note: "" };
      const key = registerPlace(p);

      const summary = (item.d || '').split('\n')[0].trim();
      const summaryHtml = summary ? `<div class="d" style="margin-top:4px;">${escapeHtml(summary)}</div>` : '';

      html += `
        <li>
          <span class="meal-item-link"
                data-action="open-meal"
                data-placekey="${key}"
                data-desc="${escapeAttr(item.d || '')}">
            ${escapeHtml(p.name)}
          </span>
          ${summaryHtml}
        </li>
      `;
    });

    html += `</ul></div>`;
  });

  html += `</div>`;
  document.getElementById('content').innerHTML = html;
};

window.selectDay = (id) => {
  currentDayId = id;
  todayMode = false;
  syncTodayBtn();
  renderAll();
};

const syncTodayBtn = () => {
  const btn = document.getElementById('todayBtn');
  btn.textContent = `ä»Šå¤©æ¨¡å¼ï¼š${todayMode ? 'é–‹' : 'é—œ'}`;
  btn.classList.toggle('primary', todayMode);
};

window.toggleTodayMode = () => {
  todayMode = !todayMode;
  syncTodayBtn();
  if(todayMode) applyTodayMode();
  else renderAll();
};

window.openHomeDir = () => {
  window.open(toMapsDir(HOME.q), '_blank', 'noopener');
};

/* =========================
   Today Mode apply
========================= */
const applyTodayMode = () => {
  if(!todayMode) return;

  const iso = todayIso();
  const found = itinerary.find(x => x.date === iso);
  if(found){
    currentDayId = found.id;
  }
  renderAll();

  requestAnimationFrame(() => {
    const dayObj = itinerary.find(x => x.id === currentDayId);
    if(!dayObj) return;

    const idx = getNextIndexForDay(dayObj);

    // clear old next
    document.querySelectorAll('.item-card.next').forEach(el => el.classList.remove('next'));

    const cards = Array.from(document.querySelectorAll('.timeline .item-card'));
    const target = cards[idx];
    if(target){
      target.classList.add('next');
      target.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    // main note -> next stop summary (only if today exists)
    if(dayObj.date === iso){
      const it = dayObj.timeline[idx];
      const p = it.place || { name: it.what, q: it.q || it.what };
      const now = new Date();
      const dt = parseTimeOnDate(iso, it.time);
      const mins = Math.round((dt - now)/60000);
      const eta = mins > 0 ? `ç´„ ${mins} åˆ†é˜å¾Œ` : 'å°±æ˜¯ç¾åœ¨/å·²é';
      document.getElementById('mainNote').textContent =
        `ä»Šå¤©æ¨¡å¼ï¼šä¸‹ä¸€ç«™ ${it.time}ï½œ${p.name}ï¼ˆ${eta}ï¼‰`;
    }
  });
};

/* =========================
   Full-text search (results list)
========================= */
const placeText = (p) => {
  if(!p) return '';
  const acc = p.access || {};
  return [
    p.name, p.thai, p.q, p.address, p.note,
    acc.bts, acc.mrt, acc.exit, acc.pier, acc.lastMile
  ].filter(Boolean).join(' ');
};

const dayBlob = (d) => {
  const tl = (d.timeline || []).map(x => `${x.time} ${placeText(x.place)} ${x.desc || ''}`).join(' ');
  const tr = (d.transport?.steps || []).map(x => `${x.a} ${x.b}`).join(' ');
  const ml = ['breakfast','lunch','dinner']
    .flatMap(k => (d.meals?.[k] || []).map(x => `${placeText(x.place)} ${x.d || ''}`))
    .join(' ');
  return `${d.day} ${d.title} ${d.note} ${formatDateZh(d.date)} ${tl} ${tr} ${ml}`.toLowerCase();
};

window.handleSearch = () => {
  const q = document.getElementById('q').value.trim().toLowerCase();
  if(!q){
    if(todayMode) applyTodayMode();
    else renderAll();
    return;
  }

  // while searching, disable today mode
  todayMode = false;
  syncTodayBtn();

  const hits = itinerary
    .map(d => ({ d, blob: dayBlob(d) }))
    .filter(x => x.blob.includes(q))
    .map(x => x.d);

  if(hits.length === 0){
    document.getElementById('content').innerHTML =
      `<div style="padding:14px; color:var(--muted); font-weight:900;">æ‰¾ä¸åˆ°ã€Œ${q}ã€ç›¸é—œå…§å®¹</div>`;
    return;
  }

  document.getElementById('content').innerHTML = `
    <div class="section-header"><div class="dot" style="background:rgba(231,207,134,0.9)"></div><span>ğŸ” æœå°‹çµæœ</span></div>
    <div class="timeline">
      ${hits.map(d => `
        <div class="item-card" onclick="selectDay(${d.id})" style="cursor:pointer;">
          <div class="item-content">
            <div class="time-tag">${d.day}</div>
            <div class="what">
              <div class="w">${d.title}</div>
              <div class="d">${formatDateZh(d.date)}ï½œ${d.note}</div>
            </div>
          </div>
          <div class="item-footer"><span style="color:var(--muted);font-weight:900;">é»æ“Šåˆ‡æ›åˆ°é€™ä¸€å¤©</span><span style="color:var(--thai-teal);font-weight:900;">â†—</span></div>
        </div>
      `).join('')}
    </div>
  `;
};

/* =========================
   Init
========================= */
window.onload = () => {
  syncTodayBtn();
  applyTodayMode();

  const iso = todayIso();
  const hasToday = itinerary.some(x => x.date === iso);
  if(!hasToday){
    renderAll();
  }
};
</script>
</body>

</html>


